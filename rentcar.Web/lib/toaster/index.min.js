/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/toaster@0.1.2/index.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var Toaster,File,Image,path=require("path"),fs=require("fs"),dirname=path.dirname,join=path.join,exists=path.exists,events=require("events"),fr=require("fructose"),errors=require("express-errors"),Class=require("Class"),async=require("async"),mkdirp=require("mkdirp"),gm=require("gm");function hashToPath(i){return i.split(/(.{2})/).join("/").replace(/\/\//g,"/")}Toaster=Class.create({initialize:function(i){var t=this;if("object"!=typeof i)throw new Error("Toaster: options required");i.target=i.target.replace(/\/$/,""),mkdirp(i.target,function(e){if(e)throw new Error(e);switch(i.type){case"file":t.Handler=File;break;case"image":i.resize&&(i.resize=t.parseSize(i.resize)),i.crop&&(i.crop=t.parseSize(i.crop)),t.Handler=Image;break;default:throw new Error('Toaster: "type" option required or unsupported type passed')}i.fields||(i.fields=["file"]),Array.isArray(i.fields)||(i.fields=[i.fields]),t.options=i,process.nextTick(function(){t.emit("ready")})})},parseSize:function(i){var t,e=[];return Array.isArray(i)||(i=[i]),i.forEach(function(i){t=i.split("x"),e.push({width:t.shift(),height:t.shift(),raw:i})}),e},uploadMiddleware:function(){var i=this;return function(t,e,r){i.iterator(t.files,function(i,e){if(i)return r(i);t.files=e,r()})}},sendfileMiddleware:function(){var i=this;return function(t,e,r){var s,a,n=t.params.filename;if(!(s=n.match(/^[0-9x0-9-]*([a-f0-9]{40})\.[a-z]{1,10}$/)))return r(errors.NotFound);a=i.options.target+hashToPath(s[1])+n,e.sendfile(a)}},iterator:function(i,t){var e=this;async.map(this.options.fields,function(t,r){var s=i[t];if(!s)return r(null,!1);new e.Handler(s,e.options).save(r)},function(i,r){if(i)return t(i);var s={},a=e.options.fields;for(var n in r)s[a[n]]=r[n];t(null,s)})}},events.EventEmitter.prototype),File=Class.create({initialize:function(i,t){this.file=i,this.options=t,this.tasks=[],this.tasks.unshift(this._mkdirp),this.tasks.unshift(this._determinePath),this.tasks.unshift(this._hash)},_hash:function(i,t){var e=this;fr.sha1File(i.path,function(i,r){if(i)return t(i);e.hash=r,t()})},_determinePath:function(i,t){var e=hashToPath(this.hash);this.filename=this.hash,i.name=/(\.[a-z]+)$/i.exec(i.name),i.name&&(this.filename+=i.name[0].toLowerCase()),this.directory=this.options.target+e,this.path=this.directory+this.filename,t()},_mkdirp:function(i,t){mkdirp(this.directory,t)},_move:function(i,t){fr.move(i.path,this.path,t)},save:function(i){var t=this;this.options.keepTmp||this.tasks.push(this._move),async.mapSeries(this.tasks,function(i,e){i.call(t,t.file,e)},function(e){if(e)return i(e);i(null,t)})}}),Image=Class.create(File,{initialize:function(i,t,e){i.call(this,t,e),e.resize&&this.tasks.push(this._resize),e.crop&&this.tasks.push(this._crop),this.gm=gm(t.path)},writePath:function(i){return this.directory+i.raw+"-"+this.filename},_resize:function(i,t){var e=this;async.map(this.options.resize,function(i,t){e.gm.quality(100).resize(i.width,i.height).write(e.writePath(i),t)},t)},_crop:function(i,t){var e=this;async.map(this.options.crop,function(i,t){e.gm.thumb(i.width,i.height,e.writePath(i),100,t)},t)}}),module.exports=Toaster;
//# sourceMappingURL=/sm/5decbce5d5dd4b812fffc882350dcff843cd0a2f59ac40dce7aa5a816d042375.map